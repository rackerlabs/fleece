version: 2.1

executors:
  py36:
    working_directory: ~/repo
    docker:
      - image: circleci/python:3.6

jobs:
  install_dependencies_py3:
    executor: py36
    steps:
      - checkout
      - restore_cache:
          key: virtualenv-py3-v1-{{ checksum "poetry.lock" }}
      - attach_workspace:
          at: ~/repo
      - run:
          name: Install Python build dependencies
          command: |
            poetry install
      - persist_to_workspace:
          root: ~/repo
          paths: [.venv]
      - save_cache:
          key: virtualenv-py3-v1-{{ checksum "poetry.lock" }}
          paths: [.venv]
  test_py3:
    executor: py36
    steps:
      - checkout
      - restore_cache:
          key: virtualenv-py3-v1-{{ checksum "poetry.lock" }}
      - attach_workspace:
          at: ~/repo
      - run:
          name: Run tests
          command: |
            poetry run task ci
      - save_cache:
          key: virtualenv-py3-v1-{{ checksum "poetry.lock" }}
          paths: [.venv]

workflows:
  version: 2
  test:
    jobs:
      - install_dependencies_py3
      - test_py3:
          requires: [install_dependencies_py3]
